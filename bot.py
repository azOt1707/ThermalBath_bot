–î–∞, —ç—Ç–æ –æ—Ç–ª–∏—á–Ω–∞—è –∏–¥–µ—è. –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —á–∞—Ç–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π ‚Äî —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ (¬´–ß–∞—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞¬ª –∏–ª–∏ ¬´–ß–∞—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏¬ª).

–Ø –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª –¥–ª—è –≤–∞—Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥, –≤ –∫–æ—Ç–æ—Ä–æ–º:

–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –∞–¥–º–∏–Ω—ã (–ê–ª—å–±–∏–Ω–∞ –∏ –≠–ª–∏–Ω–æ—á–∫–∞). –¢–µ–ø–µ—Ä—å –æ–Ω–∏ —Ç–æ–∂–µ –º–æ–≥—É—Ç —Å–∫–∞—á–∏–≤–∞—Ç—å —Ç–∞–±–µ–ª—å –∏ –æ—á–∏—â–∞—Ç—å –±–∞–∑—É.

–ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –æ–±—â–∏–π —á–∞—Ç.

–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ /chatid, —á—Ç–æ–±—ã –≤—ã –ª–µ–≥–∫–æ —É–∑–Ω–∞–ª–∏ ID –≤–∞—à–µ–π –≥—Ä—É–ø–ø—ã.

‚öôÔ∏è –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ (3 —à–∞–≥–∞)
–®–∞–≥ 1. –°–æ–∑–¥–∞–π—Ç–µ –≥—Ä—É–ø–ø—É –≤ Telegram

–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É (–Ω–∞–∑–æ–≤–∏—Ç–µ –µ—ë, –Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–¢–µ—Ä–º—ã: –ö–æ–Ω—Ç—Ä–æ–ª—å¬ª).

–î–æ–±–∞–≤—å—Ç–µ —Ç—É–¥–∞:

–°–µ–±—è.

–ê–ª—å–±–∏–Ω—É.

–≠–ª–∏–Ω–æ—á–∫—É.

–í–∞—à–µ–≥–æ –±–æ—Ç–∞ (–Ω–∞–π–¥–∏—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫ –∏ –¥–æ–±–∞–≤—å—Ç–µ –∫–∞–∫ —É—á–∞—Å—Ç–Ω–∏–∫–∞).

–°–¥–µ–ª–∞–π—Ç–µ –±–æ—Ç–∞ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –≥—Ä—É–ø–ø—ã (—ç—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –æ–Ω –º–æ–≥ –ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π).

–®–∞–≥ 2. –û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–¥ bot.py

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –Ω–∏–∂–µ —Ü–µ–ª–∏–∫–æ–º –∏ –∑–∞–º–µ–Ω–∏—Ç–µ –∏–º —Ñ–∞–π–ª bot.py –Ω–∞ GitHub.

–í —ç—Ç–æ–º –∫–æ–¥–µ —è —É–∂–µ –ø—Ä–æ–ø–∏—Å–∞–ª ID –ê–ª—å–±–∏–Ω—ã –∏ –≠–ª–∏–Ω–æ—á–∫–∏ –≤ —Å–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–æ–≤. –í–∞–º –æ—Å—Ç–∞–Ω–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–ø–∏—Å–∞—Ç—å ID –≥—Ä—É–ø–ø—ã (—Å–º. –®–∞–≥ 3).

code
Python
download
content_copy
expand_less
import logging
import os
import re
import pandas as pd
import psycopg2
import pytz
from datetime import datetime, time, timedelta
from dotenv import load_dotenv

# Telegram –∏ –ö–∞–ª–µ–Ω–¥–∞—Ä—å
from telegram import Update, ReplyKeyboardMarkup, ReplyKeyboardRemove
from telegram.ext import (
    ApplicationBuilder,
    ContextTypes,
    CommandHandler,
    MessageHandler,
    ConversationHandler,
    CallbackQueryHandler,
    filters,
)
from telegram_bot_calendar import DetailedTelegramCalendar, LSTEP

# –î–ª—è Excel
from openpyxl.styles import Font, Alignment, Border, Side

# –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
load_dotenv()
TOKEN = os.getenv("BOT_TOKEN")
DATABASE_URL = os.getenv("DATABASE_URL")

# --- –ù–ê–°–¢–†–û–ô–ö–ò –ê–î–ú–ò–ù–û–í –ò –ß–ê–¢–û–í ---

# 1. –°–ø–∏—Å–æ–∫ ID –≤—Å–µ—Ö –∞–¥–º–∏–Ω–æ–≤ (–ö–æ–º—É –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å /export –∏ /clear)
ADMIN_LIST = [
    617492397,  # –ê–∑–∞—Ç (–í–∞—à ID)
    802271920,  # –ê–ª—å–±–∏–Ω–∞
    806725469   # –≠–ª–∏–Ω–æ—á–∫–∞
]

# 2. ID –ì–†–£–ü–ü–´ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –æ–ø–æ–∑–¥–∞–Ω–∏—è—Ö
# –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤ –≥—Ä—É–ø–ø—É –∫–æ–º–∞–Ω–¥—É /chatid, —É–∑–Ω–∞–π—Ç–µ –Ω–æ–º–µ—Ä –∏ –≤–ø–∏—à–∏—Ç–µ —Å—é–¥–∞!
# –ù–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å –º–∏–Ω—É—Å–æ–º, –Ω–∞–ø—Ä–∏–º–µ—Ä: -100123456789
ALARM_CHAT_ID = None  # <--- –í–ü–ò–°–ê–¢–¨ –°–Æ–î–ê ID –ì–†–£–ü–ü–´ (–ø–æ–∑–∂–µ)

# 3. –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –∏ –ì—Ä–∞–Ω–∏—Ü–∞ –æ–ø–æ–∑–¥–∞–Ω–∏—è
TIMEZONE = pytz.timezone('Asia/Yekaterinburg') 
LATE_LIMIT = time(9, 16) # –û–ø–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å–ª–µ 09:16

# –õ–æ–≥–∏
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –æ—Ç–¥–µ–ª–æ–≤
DEPT_MAP = {
    "rescue": "üÜò –°–ø–∞—Å–∞—Ç–µ–ª–∏",
    "lockers": "üîê –õ–æ–∫–µ—Ä—ã",
    "admin": "üë®‚Äçüíª –ê–¥–º–∏–Ω.",
    "tech": "üîß –¢–µ—Ö. –æ—Ç–¥–µ–ª"
}
DEPT_REVERSE_MAP = {v: k for k, v in DEPT_MAP.items()}

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞
buttons_list = list(DEPT_MAP.values())
dept_rows = [buttons_list[i:i + 2] for i in range(0, len(buttons_list), 2)]
DEPT_KEYBOARD = ReplyKeyboardMarkup(dept_rows, resize_keyboard=True, one_time_keyboard=True)

MAIN_MENU_KEYBOARD = ReplyKeyboardMarkup(
    [["üëã –ü—Ä–∏—Ö–æ–¥", "üèÅ –£—Ö–æ–¥"], ["üë§ –ú–æ–µ –§–ò–û"]], 
    resize_keyboard=True, one_time_keyboard=False
)

# –°–æ—Å—Ç–æ—è–Ω–∏—è
REGISTER_NAME, SELECT_DATE, DEPARTMENT, TIME_INPUT = range(4)

# --- –ë–ê–ó–ê –î–ê–ù–ù–´–• ---
def get_db_connection():
    return psycopg2.connect(DATABASE_URL, sslmode='require')

def init_db():
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS records (
            id SERIAL PRIMARY KEY,
            user_id BIGINT,
            full_name TEXT,
            date TEXT,
            department TEXT,
            check_in TEXT,
            check_out TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            user_id BIGINT PRIMARY KEY,
            real_name TEXT
        )
    ''')
    conn.commit()
    cursor.close()
    conn.close()

def get_user_name(user_id):
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT real_name FROM users WHERE user_id = %s", (user_id,))
    result = cursor.fetchone()
    cursor.close()
    conn.close()
    return result[0] if result else None

def register_user_db(user_id, real_name):
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("""
        INSERT INTO users (user_id, real_name) 
        VALUES (%s, %s)
        ON CONFLICT (user_id) 
        DO UPDATE SET real_name = EXCLUDED.real_name;
    """, (user_id, real_name))
    conn.commit()
    cursor.close()
    conn.close()

def clear_all_records():
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("DELETE FROM records") 
    conn.commit()
    cursor.close()
    conn.close()

def save_check_in(user_id, date_str, dept_code, time_str):
    real_name = get_user_name(user_id) or "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT id FROM records WHERE user_id = %s AND date = %s", (user_id, date_str))
    existing = cursor.fetchone()
    if existing:
        cursor.execute('UPDATE records SET check_in = %s, department = %s, full_name = %s WHERE id = %s', 
                       (time_str, dept_code, real_name, existing[0]))
        status = "updated"
    else:
        cursor.execute('INSERT INTO records (user_id, full_name, date, department, check_in) VALUES (%s, %s, %s, %s, %s)', 
                       (user_id, real_name, date_str, dept_code, time_str))
        status = "created"
    conn.commit(); cursor.close(); conn.close()
    return status

def save_check_out(user_id, selected_date_str, time_str):
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute('UPDATE records SET check_out = %s WHERE user_id = %s AND date = %s', (time_str, user_id, selected_date_str))
    if cursor.rowcount > 0:
        conn.commit(); cursor.close(); conn.close()
        return True, selected_date_str
    try:
        dt = datetime.strptime(selected_date_str, "%Y-%m-%d")
        prev_date_str = (dt - timedelta(days=1)).strftime("%Y-%m-%d")
        cursor.execute('UPDATE records SET check_out = %s WHERE user_id = %s AND date = %s AND check_out IS NULL', (time_str, user_id, prev_date_str))
        if cursor.rowcount > 0:
            conn.commit(); cursor.close(); conn.close()
            return True, prev_date_str
    except Exception: pass
    cursor.close(); conn.close()
    return False, None

def validate_time_format(time_text):
    return re.match(r"^([01]\d|2[0-3]):([0-5]\d)$", time_text) is not None

def generate_timesheet():
    conn = get_db_connection()
    try:
        df = pd.read_sql_query("SELECT * FROM records", conn)
    except Exception: return None
    finally: conn.close()
    if df.empty: return None

    df['department'] = df['department'].map(DEPT_MAP).fillna(df['department'])
    def calc_hours(row):
        try:
            if not row['check_in'] or not row['check_out']: return 0
            t1 = datetime.strptime(row['check_in'], "%H:%M")
            t2 = datetime.strptime(row['check_out'], "%H:%M")
            if t2 < t1: t2 += timedelta(days=1)
            raw_hours = (t2 - t1).total_seconds() / 3600
            return round(max(0, raw_hours - 1.0), 2)
        except: return 0

    df['worked_hours'] = df.apply(calc_hours, axis=1)
    df['dt_obj'] = pd.to_datetime(df['date'], dayfirst=False, errors='coerce')
    mask = df['dt_obj'].isna()
    if mask.any(): df.loc[mask, 'dt_obj'] = pd.to_datetime(df.loc[mask, 'date'], dayfirst=True, errors='coerce')
    df = df.dropna(subset=['dt_obj'])
    df['day'] = df['dt_obj'].dt.day
    
    pivot = df.pivot_table(index=['department', 'full_name'], columns='day', values='worked_hours', aggfunc='sum').fillna(0)
    pivot['–ò–¢–û–ì–û'] = pivot.sum(axis=1)

    filename = f"Tabel_{datetime.now().strftime('%Y-%m-%d')}.xlsx"
    with pd.ExcelWriter(filename, engine='openpyxl') as writer:
        pivot.to_excel(writer, sheet_name='–¢–∞–±–µ–ª—å')
        worksheet = writer.sheets['–¢–∞–±–µ–ª—å']
        thin = Border(left=Side(style='thin'), right=Side(style='thin'), top=Side(style='thin'), bottom=Side(style='thin'))
        for row in worksheet.iter_rows():
            for cell in row:
                cell.border = thin
                cell.alignment = Alignment(horizontal='center', vertical='center')
        worksheet.column_dimensions['A'].width = 20
        worksheet.column_dimensions['B'].width = 30
    return filename

# --- –õ–û–ì–ò–ö–ê –ë–û–¢–ê ---
async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if get_user_name(update.effective_user.id):
        await update.message.reply_text("üëã –ú–µ–Ω—é:", reply_markup=MAIN_MENU_KEYBOARD)
        return ConversationHandler.END
    welcome = (
        "üëã <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π —Ç–∞–±–µ–ª—å ¬´–¢–µ—Ä–º—ã¬ª!</b>\n\n"
        "‚ÑπÔ∏è <b>–í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:</b>\n"
        "1. –í—Ä–µ–º—è —É–∫–∞–∑—ã–≤–∞–π—Ç–µ <b>—Å—Ç—Ä–æ–≥–æ –ø–æ –≥—Ä–∞—Ñ–∏–∫—É</b> (–Ω–∞–ø—Ä–∏–º–µ—Ä, 09:00).\n"
        "2. –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã—á–∏—Ç–∞–µ—Ç <b>1 —á–∞—Å</b> –Ω–∞ –æ–±–µ–¥.\n\n"
        "üöÄ <b>–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à—É –§–∞–º–∏–ª–∏—é –∏ –ò–º—è:</b>"
    )
    await update.message.reply_text(welcome, parse_mode='HTML', reply_markup=ReplyKeyboardRemove())
    return REGISTER_NAME

async def receive_registration_name(update: Update, context: ContextTypes.DEFAULT_TYPE):
    name = update.message.text.strip()
    if len(name) < 3:
        await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –§–ò–û –ø–æ–ª–Ω–æ—Å—Ç—å—é!")
        return REGISTER_NAME
    register_user_db(update.effective_user.id, name)
    await update.message.reply_text(f"‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {name}", reply_markup=MAIN_MENU_KEYBOARD)
    return ConversationHandler.END

async def my_name_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    name = get_user_name(update.effective_user.id)
    msg = f"üë§ –í—ã: <b>{name}</b>" if name else "‚ö†Ô∏è –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –ù–∞–∂–º–∏—Ç–µ /start"
    await update.message.reply_text(msg, parse_mode='HTML')

# --- –ö–û–ú–ê–ù–î–ê –î–õ–Ø –ü–û–õ–£–ß–ï–ù–ò–Ø ID –ì–†–£–ü–ü–´ ---
async def get_chat_id_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    await update.message.reply_text(f"üÜî ID —ç—Ç–æ–≥–æ —á–∞—Ç–∞: <code>{chat_id}</code>", parse_mode='HTML')

async def clear_db_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id not in ADMIN_LIST:
        await update.message.reply_text("‚õîÔ∏è –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∞.")
        return
    clear_all_records()
    await update.message.reply_text("üóë <b>–ë–∞–∑–∞ (PostgreSQL) –æ—á–∏—â–µ–Ω–∞!</b>", parse_mode='HTML')

async def start_checkin(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not get_user_name(update.effective_user.id):
        await update.message.reply_text("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ /start")
        return ConversationHandler.END
    calendar, step = DetailedTelegramCalendar(calendar_id=1, locale='ru').build()
    await update.message.reply_text("üìÖ –î–∞—Ç–∞ –ø—Ä–∏—Ö–æ–¥–∞:", reply_markup=calendar)
    context.user_data['action'] = 'in'
    return SELECT_DATE

async def start_checkout(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not get_user_name(update.effective_user.id):
        await update.message.reply_text("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ /start")
        return ConversationHandler.END
    calendar, step = DetailedTelegramCalendar(calendar_id=2, locale='ru').build()
    await update.message.reply_text("üìÖ –î–∞—Ç–∞ —É—Ö–æ–¥–∞:", reply_markup=calendar)
    context.user_data['action'] = 'out'
    return SELECT_DATE

async def calendar_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    cal_id = 1 if context.user_data.get('action') == 'in' else 2
    result, key, step = DetailedTelegramCalendar(calendar_id=cal_id, locale='ru').process(query.data)
    
    if not result and key:
        await query.edit_message_text(f"–í—ã–±–µ—Ä–∏—Ç–µ {LSTEP[step]}", reply_markup=key)
        return SELECT_DATE
    elif result:
        date_str = result.strftime("%Y-%m-%d")
        context.user_data['date'] = date_str
        await query.edit_message_text(f"üóì –î–∞—Ç–∞: {result.strftime('%d.%m.%Y')}")
        if context.user_data['action'] == 'in':
            await context.bot.send_message(query.message.chat_id, "üè¢ –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª:", reply_markup=DEPT_KEYBOARD)
            return DEPARTMENT
        else:
            await context.bot.send_message(query.message.chat_id, "üïí –í—Ä–µ–º—è —É—Ö–æ–¥–∞ (—á—á:–º–º):", reply_markup=ReplyKeyboardRemove())
            return TIME_INPUT

async def receive_department(update: Update, context: ContextTypes.DEFAULT_TYPE):
    dept_code = DEPT_REVERSE_MAP.get(update.message.text)
    if not dept_code:
        await update.message.reply_text("‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª –∫–Ω–æ–ø–∫–æ–π!", reply_markup=DEPT_KEYBOARD)
        return DEPARTMENT
    context.user_data['dept'] = dept_code
    await update.message.reply_text("üïí –í—Ä–µ–º—è –ø—Ä–∏—Ö–æ–¥–∞ (—á—á:–º–º):", reply_markup=ReplyKeyboardRemove())
    return TIME_INPUT

async def receive_time(update: Update, context: ContextTypes.DEFAULT_TYPE):
    time_str = update.message.text.strip()
    if not validate_time_format(time_str):
        await update.message.reply_text("‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ <b>—á—á:–º–º</b> (09:00).", parse_mode='HTML')
        return TIME_INPUT
    
    data = context.user_data
    user_id = update.effective_user.id
    
    if data['action'] == 'in':
        # --- –ü–†–û–í–ï–†–ö–ê –û–ü–û–ó–î–ê–ù–ò–ô ---
        try:
            now_local = datetime.now(TIMEZONE)
            if data['date'] == now_local.strftime("%Y-%m-%d"):
                if LATE_LIMIT < now_local.time() < time(12, 0):
                    user_name = get_user_name(user_id)
                    alert_text = (
                        f"‚ö†Ô∏è <b>–û–ü–û–ó–î–ê–ù–ò–ï!</b>\nüë§ {user_name}\n"
                        f"üìÖ {data['date']}\n‚è∞ –§–∞–∫—Ç: <b>{now_local.strftime('%H:%M')}</b>\n‚úçÔ∏è –í–ø–∏—Å–∞–ª: {time_str}"
                    )
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –û–ë–©–ò–ô –ß–ê–¢, –µ—Å–ª–∏ –æ–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω
                    if ALARM_CHAT_ID:
                        await context.bot.send_message(chat_id=ALARM_CHAT_ID, text=alert_text, parse_mode='HTML')
                    # –ò–Ω–∞—á–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ–º –∞–¥–º–∏–Ω–∞–º –≤ –ª–∏—á–∫—É
                    else:
                        for admin_id in ADMIN_LIST:
                            try:
                                await context.bot.send_message(chat_id=admin_id, text=alert_text, parse_mode='HTML')
                            except: pass
        except Exception as e: logger.error(f"Alert Error: {e}")

        status = save_check_in(user_id, data['date'], data['dept'], time_str)
        dept_name = DEPT_MAP.get(data['dept'], data['dept'])
        msg = f"‚úÖ <b>–ü—Ä–∏—Ö–æ–¥:</b> {data['date']}\nüè¢ {dept_name}\nüïò {time_str}" if status == "created" else f"üîÑ <b>–û–±–Ω–æ–≤–ª–µ–Ω–æ:</b> {data['date']}\nüè¢ {dept_name}\nüïò {time_str}"
        await update.message.reply_text(msg, parse_mode='HTML', reply_markup=MAIN_MENU_KEYBOARD)
    else:
        success, date_closed = save_check_out(user_id, data['date'], time_str)
        if success:
            msg = f"üèÅ <b>–£—Ö–æ–¥:</b> {date_closed} | {time_str}" + (f"\n(–ó–∞–∫—Ä—ã—Ç–∞ —Å–º–µ–Ω–∞ –∑–∞ {date_closed})" if date_closed != data['date'] else "")
            await update.message.reply_text(msg, parse_mode='HTML', reply_markup=MAIN_MENU_KEYBOARD)
        else:
            await update.message.reply_text("‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Å–º–µ–Ω.", reply_markup=MAIN_MENU_KEYBOARD)
            
    context.user_data.clear()
    return ConversationHandler.END

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("‚ùå –û—Ç–º–µ–Ω–∞", reply_markup=MAIN_MENU_KEYBOARD)
    context.user_data.clear()
    return ConversationHandler.END

async def send_report_job(context: ContextTypes.DEFAULT_TYPE):
    filename = generate_timesheet()
    if not filename: return
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á–µ—Ç –≤ –ì–†–£–ü–ü–£, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
    if ALARM_CHAT_ID:
        try:
            await context.bot.send_message(ALARM_CHAT_ID, "üìä –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Ç–∞–±–µ–ª—å")
            await context.bot.send_document(ALARM_CHAT_ID, open(filename, 'rb'))
        except: pass
    else:
        # –ò–Ω–∞—á–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ–º –∞–¥–º–∏–Ω–∞–º
        for admin_id in ADMIN_LIST:
            try:
                await context.bot.send_message(admin_id, "üìä –¢–∞–±–µ–ª—å")
                await context.bot.send_document(admin_id, open(filename, 'rb'))
            except: pass

async def manual_export(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id in ADMIN_LIST:
        await send_report_job(context)

if __name__ == '__main__':
    if not DATABASE_URL: print("–û–®–ò–ë–ö–ê: –ù–µ –∑–∞–¥–∞–Ω DATABASE_URL –≤ .env")
    else:
        init_db()
        application = ApplicationBuilder().token(TOKEN).build()
        conv_handler_kwargs = {'allow_reentry': True}
        
        conv_reg = ConversationHandler(
            entry_points=[CommandHandler('start', start_command)],
            states={REGISTER_NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, receive_registration_name)]},
            fallbacks=[], **conv_handler_kwargs
        )
        conv_in = ConversationHandler(
            entry_points=[CommandHandler('checkin', start_checkin), MessageHandler(filters.Regex("^üëã –ü—Ä–∏—Ö–æ–¥$"), start_checkin)],
            states={
                SELECT_DATE: [CallbackQueryHandler(calendar_handler, pattern="^cbcal_")],
                DEPARTMENT: [MessageHandler(filters.TEXT, receive_department)],
                TIME_INPUT: [MessageHandler(filters.TEXT, receive_time)]
            },
            fallbacks=[CommandHandler('cancel', cancel)], **conv_handler_kwargs
        )
        conv_out = ConversationHandler(
            entry_points=[CommandHandler('checkout', start_checkout), MessageHandler(filters.Regex("^üèÅ –£—Ö–æ–¥$"), start_checkout)],
            states={
                SELECT_DATE: [CallbackQueryHandler(calendar_handler, pattern="^cbcal_")],
                TIME_INPUT: [MessageHandler(filters.TEXT, receive_time)]
            },
            fallbacks=[CommandHandler('cancel', cancel)], **conv_handler_kwargs
        )
        
        application.add_handler(conv_reg)
        application.add_handler(conv_in)
        application.add_handler(conv_out)
        application.add_handler(CommandHandler('export', manual_export))
        application.add_handler(CommandHandler('clear', clear_db_command))
        # –ù–û–í–ê–Ø –ö–û–ú–ê–ù–î–ê –î–õ–Ø –£–ó–ù–ê–í–ê–ù–ò–Ø ID –ß–ê–¢–ê
        application.add_handler(CommandHandler('chatid', get_chat_id_command))
        application.add_handler(MessageHandler(filters.Regex("^üë§ –ú–æ–µ –§–ò–û$"), my_name_command))
        
        application.job_queue.run_daily(send_report_job, time=time(hour=23, minute=0), days=(6,))
        print("–ë–æ—Ç (PRO: Multi-Admin + Chat Alarm) –∑–∞–ø—É—â–µ–Ω!")
        application.run_polling()
–®–∞–≥ 3. –£–∑–Ω–∞–µ–º ID –≥—Ä—É–ø–ø—ã –∏ –≤–ø–∏—Å—ã–≤–∞–µ–º –µ–≥–æ (–§–∏–Ω–∞–ª—å–Ω—ã–π —à—Ç—Ä–∏—Ö)

–ó–∞–ª–µ–π—Ç–µ –∫–æ–¥ –Ω–∞ GitHub –∏ –¥–æ–∂–¥–∏—Ç–µ—Å—å, –ø–æ–∫–∞ Koyeb –æ–±–Ω–æ–≤–∏—Ç—Å—è.

–ó–∞–π–¥–∏—Ç–µ –≤ –≤–∞—à—É –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É ¬´–¢–µ—Ä–º—ã: –ö–æ–Ω—Ç—Ä–æ–ª—å¬ª.

–ù–∞–ø–∏—à–∏—Ç–µ —Ç—É–¥–∞ –∫–æ–º–∞–Ω–¥—É: /chatid

–ë–æ—Ç –æ—Ç–≤–µ—Ç–∏—Ç: üÜî ID —ç—Ç–æ–≥–æ —á–∞—Ç–∞: -10012345678 (—Ü–∏—Ñ—Ä—ã –±—É–¥—É—Ç –¥—Ä—É–≥–∏–µ).

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç –Ω–æ–º–µ—Ä (–≤–º–µ—Å—Ç–µ —Å –º–∏–Ω—É—Å–æ–º!).

–ò–¥–∏—Ç–µ –Ω–∞ GitHub -> bot.py -> ‚úèÔ∏è Edit.

–í—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –Ω–æ–º–µ—Ä –≤ —Å—Ç—Ä–æ–∫—É 43:

code
Python
download
content_copy
expand_less
ALARM_CHAT_ID = -10012345678  # <--- –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤–∞—à –Ω–æ–º–µ—Ä —Å –º–∏–Ω—É—Å–æ–º!

–ù–∞–∂–º–∏—Ç–µ Commit changes.

–í—Å–µ!
–¢–µ–ø–µ—Ä—å –æ–ø–æ–∑–¥–∞–Ω–∏—è –∏ –≤–µ—á–µ—Ä–Ω–∏–π –æ—Ç—á–µ—Ç –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –≤ —ç—Ç—É –≥—Ä—É–ø–ø—É, –≥–¥–µ —Å–∏–¥—è—Ç –ê–ª—å–±–∏–Ω–∞ –∏ –≠–ª–∏–Ω–æ—á–∫–∞. –ò –æ–Ω–∏ —Ç–æ–∂–µ —Å–º–æ–≥—É—Ç –Ω–∞–∂–∞—Ç—å /export –≤ –ª–∏—á–∫–µ —Å –±–æ—Ç–æ–º, –µ—Å–ª–∏ –∑–∞—Ö–æ—Ç—è—Ç.
